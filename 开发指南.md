# Toukatsukyoku-Goetia-System 开发指南

## 一、项目概述

本项目是一个分布式深度学习训练管理系统，采用 Master-Agent 架构，支持远程任务调度、实验管理、模型导出等功能。

### 核心模块划分

| 模块 | 描述 | 技术栈 | 预估工时(AI辅助) |
|------|------|--------|------------------|
| **Master端** | 本地中控，任务调度 | Python, WebSocket | 3-4周 |
| **Agent端** | 云端执行器 | Python, PyTorch | 2-3周 |
| **Components组件库** | 模型/数据集/损失函数等 | Python, PyTorch | 4-5周 |
| **API层** | RESTful + WebSocket | FastAPI | 2周 |
| **WebUI** | 前端界面 | Vue3, Vite, TailwindCSS | 3-4周 |
| **Database** | 数据持久化 | SQLAlchemy, PostgreSQL | 1周 |
| **Export模块** | 模型导出 | ONNX, TensorRT等 | 2周 |
| **Visualization** | 可视化分析 | Matplotlib, Plotly | 1.5周 |
| **Configs** | Hydra配置系统 | Hydra, YAML | 1周 |
| **Registry** | 全局注册器 | Python | 0.5周 |

**总预估开发周期：8-10周（AI辅助并行开发）**

---

## 二、模块依赖关系分析

```
                    ┌─────────────┐
                    │   WebUI     │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │    API      │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
┌───────▼───────┐  ┌───────▼───────┐  ┌───────▼───────┐
│    Master     │  │   Database    │  │ Visualization │
└───────┬───────┘  └───────────────┘  └───────────────┘
        │
        │ WebSocket
        │
┌───────▼───────┐
│    Agent      │
└───────┬───────┘
        │
┌───────▼───────┐
│  Components   │ ◄── Registry, Configs
└───────────────┘
```

### 依赖层级

**Layer 0 (基础层 - 无依赖)**
- `registry/` - 全局注册器
- `configs/` - 配置系统
- `logging/` - 日志系统

**Layer 1 (核心组件层)**
- `components/` - 依赖 registry, configs
- `database/` - 独立

**Layer 2 (功能层)**
- `agent/runtime_core/` - 依赖 components
- `export/` - 依赖 components
- `visualization/` - 依赖 components
- `analysis/` - 依赖 components

**Layer 3 (服务层)**
- `master/` - 依赖 Layer 0-2
- `agent/` - 依赖 runtime_core, components

**Layer 4 (接口层)**
- `api/` - 依赖 master, database
- `experiment/` - 依赖 database, logging

**Layer 5 (展示层)**
- `webui/` - 依赖 api

---

## 三、并行开发策略

### 可并行开发的模块组

```
┌─────────────────────────────────────────────────────────────────┐
│                        Phase 1 (Week 1-2)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │
│  │ Registry │  │ Configs  │  │ Logging  │  │ Database Models  │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        Phase 2 (Week 2-5)                       │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Components (并行)                        │ │
│  │  ┌────────┐ ┌─────────┐ ┌───────┐ ┌─────────┐ ┌─────────┐  │ │
│  │  │ Models │ │Datasets │ │Losses │ │ Metrics │ │  Augs   │  │ │
│  │  └────────┘ └─────────┘ └───────┘ └─────────┘ └─────────┘  │ │
│  └────────────────────────────────────────────────────────────┘ │
│  ┌──────────────┐  ┌──────────────┐                             │
│  │ Master/conn  │  │ Agent/conn   │  (通信层可并行)              │
│  └──────────────┘  └──────────────┘                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        Phase 3 (Week 4-7)                       │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────────┐   │
│  │ Master (完整)  │  │ Agent (完整)   │  │ Export + Visual  │   │
│  └────────────────┘  └────────────────┘  └──────────────────┘   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                      API Layer                              │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        Phase 4 (Week 6-9)                       │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                      WebUI (并行)                           │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐   │ │
│  │  │ 任务管理 │ │ 节点监控 │ │ 实验对比 │ │ 可视化中心   │   │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                       Phase 5 (Week 8-10)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ 集成测试     │  │ E2E测试      │  │ 部署脚本 + Docker    │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、详细开发路径

### Phase 1: 基础设施 (Week 1-2)

#### 并行任务组 A (开发者1 + AI)

```
registry/
├── registry.py              # 基础注册器类
├── model_registry.py        # 模型注册
├── dataset_registry.py      # 数据集注册
├── loss_registry.py         # 损失函数注册
├── metric_registry.py       # 指标注册
└── component_scanner.py     # 组件扫描器
```
**预估：2-3天**

#### 并行任务组 B (开发者2 + AI)
```
configs/
├── hydra/
│   ├── config_loader.py     # 配置加载
│   ├── config_composer.py   # 配置组合
│   └── config_validator.py  # 配置验证
└── schemas/                 # 配置Schema定义
```
**预估：3-4天**

#### 并行任务组 C (开发者3 + AI)
```
database/
├── connection.py            # 数据库连接
├── models/                  # ORM模型定义
└── repositories/            # 数据访问层
```
**预估：3-4天**

#### 并行任务组 D (开发者4 + AI)
```
logging/
├── logger.py               # 日志核心
├── formatters.py           # 格式化器
├── handlers.py             # 处理器
└── writers/                # 各类写入器
```
**预估：2天**

---

### Phase 2: 核心组件 (Week 2-5)

#### 并行任务组 A: Models组件
```
components/models/
├── backbones/    # ResNet, ViT, Swin等 (各1-2天)
├── necks/        # FPN, PAN等 (各0.5-1天)
├── heads/        # 分类/检测/分割头 (各0.5-1天)
├── detectors/    # YOLO, FCOS, DETR等 (各1-2天)
├── segmentors/   # UNet, DeepLab等 (各1-2天)
└── layers/       # 基础层 (2天)
```
**预估：2-3周**

#### 并行任务组 B: Datasets组件
```
components/datasets/
├── formats/      # COCO, VOC, YOLO格式 (各1天)
├── parsers/      # 标注解析器 (各0.5天)
└── samplers/     # 采样器 (1天)
```
**预估：1周**

#### 并行任务组 C: Losses + Metrics
```
components/losses/
├── classification/   # CE, Focal等 (各0.5天)
├── detection/        # IoU, GFocal等 (各0.5天)
└── segmentation/     # Dice, Lovasz等 (各0.5天)

components/metrics/
├── classification/   # Accuracy, F1等 (各0.5天)
├── detection/        # mAP, COCO metric (各1天)
└── segmentation/     # IoU, Dice score (各0.5天)
```
**预估：1.5周**

#### 并行任务组 D: Augmentations
```
components/augmentations/
├── geometric/    # Resize, Flip, Rotate等 (各0.5天)
├── photometric/  # ColorJitter, Normalize等 (各0.5天)
├── mixing/       # Mixup, CutMix, Mosaic (各1天)
└── pipelines/    # AutoAugment等 (1天)
```
**预估：1周**

#### 并行任务组 E: 通信层 (可与上述并行)
```
master/connection/           agent/connection/
├── websocket_server.py      ├── websocket_client.py
├── connection_pool.py       ├── heartbeat.py
├── message_handler.py       ├── reconnector.py
└── heartbeat_monitor.py     └── message_sender.py

master/protocol/ + agent对应
├── message_types.py
├── message_serializer.py
└── protocol_handler.py
```
**预估：1周**

---

### Phase 3: 功能模块 (Week 4-7)

#### 并行任务组 A: Master完整实现
```
master/
├── node_manager/     # 节点管理 (3天)
├── task_scheduler/   # 任务调度 (4天)
├── data_aggregator/  # 数据聚合 (2天)
├── packager/         # 任务打包 (2天)
├── security/         # 安全认证 (2天)
└── report_generator/ # 报告生成 (2天)
```
**预估：2周**

#### 并行任务组 B: Agent完整实现
```
agent/
├── executor/         # 执行模块 (3天)
├── reporter/         # 上报模块 (2天)
├── data_handler/     # 数据处理 (2天)
└── runtime_core/     # 运行时核心 (4天)
```
**预估：1.5周**

#### 并行任务组 C: Export + Visualization
```
export/
├── onnx_exporter.py      # ONNX导出 (2天)
├── tensorrt_exporter.py  # TensorRT (2天)
├── optimizers/           # 图优化 (2天)
└── validators/           # 验证器 (1天)

visualization/
├── feature_maps/    # 特征图可视化 (2天)
├── gradients/       # 梯度可视化 (1天)
├── statistics/      # 统计可视化 (1天)
└── metrics/         # 指标可视化 (2天)
```
**预估：2周**

#### 并行任务组 D: API层
```
api/
├── routes/          # 各类路由 (4天)
├── schemas/         # 请求/响应Schema (2天)
├── services/        # 业务服务 (3天)
├── websocket/       # WebSocket处理 (2天)
└── middleware/      # 中间件 (1天)
```
**预估：2周**

---

### Phase 4: 前端开发 (Week 6-9)

#### 并行任务组 A: 基础框架 + 公共组件
```
webui/src/
├── main.js, App.vue, router/
├── components/common/    # 公共组件
├── store/               # 状态管理
├── api/                 # API封装
└── utils/, constants/   # 工具函数
```
**预估：1周**

#### 并行任务组 B: 任务管理模块
```
views/
├── TaskCreate.vue
├── TaskList.vue
├── TaskDetail.vue
└── TaskMonitor.vue

components/task/         # 任务相关组件
components/monitor/      # 监控相关组件
```
**预估：1.5周**

#### 并行任务组 C: 节点 + 实验管理
```
views/
├── NodeList.vue
├── NodeDetail.vue
├── GpuResourcePool.vue
├── ExperimentList.vue
├── ExperimentDetail.vue
└── ExperimentCompare.vue

components/node/
components/experiment/
components/compare/
```
**预估：1.5周**

#### 并行任务组 D: 可视化 + 导出 + 报告
```
views/
├── VisualizationCenter.vue
├── ExportCenter.vue
└── ReportViewer.vue

components/visualization/
components/export/
components/report/
components/charts/
```
**预估：1.5周**

---

### Phase 5: 集成与部署 (Week 8-10)

#### 并行任务组 A: 测试
```
tests/
├── unit/           # 单元测试 (持续)
├── integration/    # 集成测试 (3天)
└── e2e/           # 端到端测试 (3天)
```

#### 并行任务组 B: 部署
```
scripts/
├── docker/         # Docker配置 (2天)
├── k8s/           # K8s配置 (2天)
└── *.sh           # 部署脚本 (1天)
```

#### 并行任务组 C: 文档
```
docs/
├── user_guide/
├── developer_guide/
├── api_reference/
└── tutorials/
```

---

## 五、AI辅助开发效率提升策略

### 5.1 高效利用AI的场景

| 场景 | AI效率提升 | 建议 |
|------|-----------|------|
| 模板代码生成 | 5-10x | 让AI生成基础类、接口定义 |
| 重复性组件 | 3-5x | 如多个backbone、loss函数 |
| 单元测试 | 3-5x | AI生成测试用例 |
| 文档编写 | 5-10x | API文档、使用说明 |
| 配置文件 | 3-5x | YAML配置模板 |
| 前端组件 | 2-3x | Vue组件、样式 |

### 5.2 需要人工主导的场景

| 场景 | 原因 |
|------|------|
| 架构设计决策 | 需要业务理解和经验判断 |
| 复杂算法实现 | 如分布式训练、混合精度 |
| 性能优化 | 需要profiling和调优经验 |
| 安全相关 | 认证、加密需谨慎 |
| 集成调试 | 跨模块问题定位 |

### 5.3 推荐的AI协作模式

```
┌─────────────────────────────────────────────────────────┐
│                    开发流程                              │
├─────────────────────────────────────────────────────────┤
│  1. 人工: 定义接口和数据结构                             │
│     ↓                                                   │
│  2. AI: 生成基础实现代码                                 │
│     ↓                                                   │
│  3. 人工: Review + 修改核心逻辑                          │
│     ↓                                                   │
│  4. AI: 生成单元测试                                     │
│     ↓                                                   │
│  5. 人工: 运行测试 + 修复问题                            │
│     ↓                                                   │
│  6. AI: 生成文档                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 六、开发优先级建议

### 6.1 MVP (最小可行产品) - 4周

**必须实现:**
- [ ] Registry + Configs 基础
- [ ] 1-2个Backbone (ResNet, ViT)
- [ ] 1个检测器 (YOLO)
- [ ] COCO数据集支持
- [ ] 基础Loss和Metrics
- [ ] Master-Agent通信
- [ ] 基础任务调度
- [ ] 简单WebUI (任务创建+监控)

### 6.2 完整版 - 8-10周

**在MVP基础上添加:**
- [ ] 完整组件库
- [ ] 模型导出
- [ ] 实验管理
- [ ] 可视化分析
- [ ] 报告生成
- [ ] 完整WebUI
- [ ] Docker部署

---

## 七、团队配置建议

### 最优配置 (4人团队)

| 角色 | 负责模块 | 技能要求 |
|------|---------|---------|
| 后端开发1 | Master + Agent | Python, 分布式系统 |
| 后端开发2 | Components + Export | PyTorch, 深度学习 |
| 前端开发 | WebUI | Vue3, 数据可视化 |
| 全栈/DevOps | API + Database + 部署 | FastAPI, Docker, K8s |

### 最小配置 (2人团队)

| 角色 | 负责模块 |
|------|---------|
| 后端全栈 | Master, Agent, Components, API, Database |
| 前端全栈 | WebUI, 可视化, 部署脚本 |

---

## 八、风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 组件库工作量大 | 延期 | 优先实现常用组件，其他迭代添加 |
| Master-Agent通信复杂 | 阻塞 | 先用简单HTTP，后优化为WebSocket |
| 前端组件多 | 延期 | 使用UI组件库(Element Plus)加速 |
| 分布式训练复杂 | 质量 | 先支持单机，分布式作为高级功能 |

---

## 九、技术栈确认

### 后端
- Python 3.10+
- PyTorch 2.0+
- FastAPI
- SQLAlchemy + PostgreSQL
- Redis (任务队列)
- WebSocket (实时通信)
- Hydra (配置管理)

### 前端
- Vue 3 + Composition API
- Vite
- TailwindCSS
- ECharts / Chart.js
- Pinia (状态管理)

### 部署
- Docker + Docker Compose
- Kubernetes (可选)
- Nginx

---

## 十、快速启动检查清单

### Week 1 启动前准备
- [ ] 确定团队分工
- [ ] 搭建开发环境
- [ ] 创建Git仓库和分支策略
- [ ] 配置CI/CD基础
- [ ] 统一代码规范 (pre-commit)

### 每日站会关注点
- 阻塞问题
- 接口变更
- 依赖模块进度

### 每周里程碑
- Week 2: 基础设施完成，可以开始组件开发
- Week 4: 核心组件完成，可以跑通简单训练
- Week 6: Master-Agent联调完成
- Week 8: WebUI基本可用
- Week 10: 完整功能，准备部署

---

*文档版本: v1.0*
*生成日期: 2024年12月11日*
